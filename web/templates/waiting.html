{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="card text-center">
        <div class="card-header">
            <h3>正在排队评分中...</h3>
        </div>
        <div class="card-body">
            <div class="mb-4">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            
            <h5 class="card-title">请稍候，系统正在处理您的试卷</h5>
            <p class="card-text" id="status-text">正在连接服务器...</p>
            
            <div class="progress mt-3" style="height: 20px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
            </div>
            
            <div id="queue-info" class="mt-3 text-muted" style="display: none;">
                当前排在第 <span id="position" class="fw-bold text-danger"></span> 位，
                共有 <span id="total" class="fw-bold"></span> 人在等待。
            </div>
        </div>
    </div>
</div>

<script>
    const taskId = "{{ task_id }}";
    const statusUrl = "{{ url_for('queue_status', task_id=task_id) }}";
    const resultUrl = "{{ url_for('view_history', result_id=task_id) }}";

    function checkStatus() {
        fetch(statusUrl)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'waiting') {
                    document.getElementById('status-text').innerText = '正在排队中...';
                    document.getElementById('queue-info').style.display = 'block';
                    document.getElementById('position').innerText = data.position;
                    document.getElementById('total').innerText = data.total_waiting;
                } else if (data.status === 'processing') {
                    document.getElementById('status-text').innerText = '正在评分中...';
                    document.getElementById('queue-info').style.display = 'none';
                } else if (data.status === 'done') {
                    window.location.href = resultUrl;
                } else if (data.status === 'error') {
                    document.getElementById('status-text').innerText = '评分出错: ' + (data.error || '未知错误');
                    document.querySelector('.spinner-border').classList.remove('text-primary');
                    document.querySelector('.spinner-border').classList.add('text-danger');
                }
            })
            .catch(err => {
                console.error('Error checking status:', err);
            });
    }

    // Check every 2 seconds
    setInterval(checkStatus, 2000);
    checkStatus(); // Initial check
</script>
{% endblock %}
