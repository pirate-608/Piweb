{% extends "base.html" %}

{% block content %}
<div class="container py-5">
    <!-- é¢åŒ…å±‘å¯¼èˆª -->
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb bg-white px-0 mb-4">
        <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">é¦–é¡µ</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('exam.start_exam') }}">ç­”é¢˜ä¸­å¿ƒ</a></li>
        {% if request.endpoint == 'exam.select_set' %}
          <li class="breadcrumb-item active" aria-current="page">é€‰æ‹©é¢˜ç›®é›†</li>
        {% elif request.endpoint == 'exam.history' %}
          <li class="breadcrumb-item active" aria-current="page">å†å²è®°å½•</li>
        {% elif request.endpoint == 'main.leaderboard' %}
          <li class="breadcrumb-item active" aria-current="page">æ’è¡Œæ¦œ</li>
        {% elif request.endpoint == 'admin_bp.add' %}
          <li class="breadcrumb-item"><a href="{{ url_for('admin_bp.manage') }}">é¢˜ç›®ç®¡ç†</a></li>
          <li class="breadcrumb-item active" aria-current="page">æ·»åŠ é¢˜ç›®</li>
        {% elif request.endpoint == 'admin_bp.manage' %}
          <li class="breadcrumb-item active" aria-current="page">é¢˜ç›®ç®¡ç†</li>
        {% else %}
          <!-- ç­”é¢˜ä¸­å¿ƒä¸»é¡µä¸æ˜¾ç¤ºé¢å¤–å±‚çº§ -->
        {% endif %}
      </ol>
    </nav>

    <div class="text-center mb-5">
        <h1 class="display-5 fw-bold">ç­”é¢˜ä¸»é¡µ</h1>
        <p class="lead text-body-secondary">æ¬¢è¿æ¥åˆ°ç­”é¢˜ä¸­å¿ƒã€‚è¯·é€‰æ‹©åŠŸèƒ½å…¥å£ï¼š</p>
        <div class="d-flex flex-wrap justify-content-center gap-3 mb-4">
            <a href="{{ url_for('exam.select_set') }}" class="btn btn-primary btn-lg">è¿›å…¥é¢˜ç›®é›†é€‰æ‹©</a>
            <a href="{{ url_for('exam.history') }}" class="btn btn-outline-success btn-lg">å†å²è®°å½•</a>
            <a href="{{ url_for('main.leaderboard') }}" class="btn btn-outline-info btn-lg">æ’è¡Œæ¦œ</a>
            {% if current_user.is_authenticated and current_user.is_admin %}
                <a href="{{ url_for('admin_bp.add') }}" class="btn btn-outline-warning btn-lg">æ·»åŠ é¢˜ç›®</a>
                <a href="{{ url_for('admin_bp.manage') }}" class="btn btn-outline-secondary btn-lg">ç®¡ç†é¢˜ç›®</a>
            {% endif %}
        </div>
    </div>
    
    {% if stats %}
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-white bg-primary mb-3 h-100">
                <div class="card-header">é¢˜åº“æ€»é‡</div>
                <div class="card-body">
                    <h1 class="card-title display-4">{{ stats.total_questions }}</h1>
                    <p class="card-text">é“å…¬å¼€é¢˜ç›®</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-success mb-3 h-100">
                {% if current_user.is_authenticated and user_stats %}
                    <div class="card-header">æˆ‘çš„ç­”é¢˜</div>
                    <div class="card-body">
                        <h1 class="card-title display-4">{{ user_stats.total_exams }}</h1>
                        <p class="card-text">æ¬¡ä¸ªäººè®°å½•</p>
                    </div>
                {% else %}
                    <div class="card-header">å…¨ç«™æ€»ç­”é¢˜æ¬¡æ•°</div>
                    <div class="card-body">
                        <h1 class="card-title display-4">{{ stats.total_exams }}</h1>
                        <p class="card-text">æ¬¡å…¨ç«™è®°å½•</p>
                    </div>
                {% endif %}
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-info mb-3 h-100">
                {% if current_user.is_authenticated and user_stats %}
                    <div class="card-header">æˆ‘çš„æ­£ç¡®ç‡</div>
                    <div class="card-body">
                        <h1 class="card-title display-4">{{ user_stats.avg_accuracy }}%</h1>
                        <p class="card-text">å¹³å‡æ­£ç¡®ç‡</p>
                    </div>
                {% else %}
                    <div class="card-header">å…¨ç«™å¹³å‡æ­£ç¡®ç‡</div>
                    <div class="card-body">
                        <h1 class="card-title display-4">{{ stats.avg_accuracy }}%</h1>
                        <p class="card-text">æ‰€æœ‰ç”¨æˆ·å¹³å‡å€¼</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if current_user.is_authenticated and current_user.is_admin %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                    <span class="fw-bold">ğŸš¦ æ™ºèƒ½æ’é˜Ÿç³»ç»Ÿç›‘æ§</span>
                    <button class="btn btn-sm btn-light" onclick="updateQueueStats()">åˆ·æ–°çŠ¶æ€</button>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-6 border-end">
                            <h3 class="display-6 text-danger" id="queue-waiting">-</h3>
                            <p class="text-body-secondary mb-0">å½“å‰æ’é˜Ÿäººæ•°</p>
                        </div>
                        <div class="col-md-6">
                            <h3 class="display-6 text-success" id="queue-active">-</h3>
                            <p class="text-body-secondary mb-0">æ­£åœ¨è¯„åˆ†ä»»åŠ¡</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if user_charts %}
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header fw-bold">ğŸ“ˆ è¿‘æœŸæˆç»©è¶‹åŠ¿ (æœ€è¿‘7æ¬¡)</div>
                <div class="card-body">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header fw-bold">âš ï¸ é«˜é¢‘é”™é¢˜ (Top 5)</div>
                <div class="card-body">
                    <canvas id="errorChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if questions_empty %}
    <div class="alert alert-warning text-center mt-4">å½“å‰é¢˜åº“ä¸ºç©ºï¼Œè¯·è”ç³»ç®¡ç†å‘˜æ·»åŠ é¢˜ç›®åå†è¯•ã€‚</div>
    {% endif %}
</div>

{% if current_user.is_authenticated and current_user.is_admin %}
<script>
function updateQueueStats() {
    fetch('/admin/queue')
        .then(r => r.json())
        .then(data => {
            if(data.error) return;
            document.getElementById('queue-waiting').innerText = data.waiting;
            document.getElementById('queue-active').innerText = data.active;
        })
        .catch(e => console.error(e));
}
document.addEventListener('DOMContentLoaded', () => {
    updateQueueStats();
    setInterval(updateQueueStats, 5000);
});
</script>
{% endif %}

{% if user_charts %}
<script src="{{ url_for('static', filename='js/chart.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Trend Chart
        const trendCtx = document.getElementById('trendChart').getContext('2d');
        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: {{ user_charts.trend.labels | tojson }},
                datasets: [{
                    label: 'ç­”é¢˜å¾—åˆ†',
                    data: {{ user_charts.trend.data | tojson }},
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        
        // Error Chart
        const errorCtx = document.getElementById('errorChart').getContext('2d');
        new Chart(errorCtx, {
            type: 'bar',
            data: {
                labels: {{ user_charts.errors.labels | tojson }},
                datasets: [{
                    label: 'é”™è¯¯æ¬¡æ•°',
                    data: {{ user_charts.errors.data | tojson }},
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.6)',
                        'rgba(54, 162, 235, 0.6)',
                        'rgba(255, 206, 86, 0.6)',
                        'rgba(75, 192, 192, 0.6)',
                        'rgba(153, 102, 255, 0.6)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                indexAxis: 'y',
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: { stepSize: 1 }
                    }
                }
            }
        });
    });
</script>
{% endif %}
{% endblock %}