{% extends 'base.html' %}
{% block title %}作品编辑{% endblock %}
{% block content %}
<div class="container mt-4">
  <!-- 分层级面包屑导航 -->
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/workshop">工坊首页</a></li>
      <li class="breadcrumb-item"><a href="/workshop/my_works">我的作品</a></li>
      <li class="breadcrumb-item active" aria-current="page">编辑作品</li>
    </ol>
  </nav>
  <h2>编辑作品</h2>
  <form id="work-form">
    <input type="hidden" id="work-id" name="id" value="{{ work_id }}">
    <input type="hidden" name="csrf_token" id="csrf_token" value="{{ csrf_token() }}">
    <div class="mb-3">
      <label for="title" class="form-label">标题</label>
      <input type="text" class="form-control" id="title" name="title" required>
    </div>
    <div class="mb-3">
      <label for="description" class="form-label">简介</label>
      <textarea class="form-control" id="description" name="description" rows="2"></textarea>
    </div>
    <div class="mb-3">
      <label for="content" class="form-label">正文</label>
      <textarea class="form-control" id="content" name="content" rows="10" required></textarea>
      <div class="mb-3 mt-2">
        <button type="button" class="btn btn-info" id="ai-continue-btn">AI续写</button>
        <label class="ms-2">温度</label>
        <input type="number" id="ai-temperature" value="0.7" min="0" max="1" step="0.1" style="width:80px;">
        <span id="ai-status" class="ms-2 text-muted"></span>
      </div>
    <script>
    // AI续写功能（与editor.html一致，可维护复用）
    window.aiContinue = function(contentId = 'content', tempId = 'ai-temperature', statusId = 'ai-status') {
      const prompt = document.getElementById(contentId).value;
      const temperature = parseFloat(document.getElementById(tempId).value) || 0.7;
      const status = document.getElementById(statusId);
      status.textContent = 'AI生成中...';
      fetch('/api/ai/continue', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt, temperature })
      })
        .then(r => r.json())
        .then(res => {
          if (res.text) {
            document.getElementById(contentId).value += res.text;
            status.textContent = '已插入AI续写内容';
          } else {
            status.textContent = res.error || 'AI续写失败';
          }
        })
        .catch(() => { status.textContent = '网络异常'; });
    };
    document.getElementById('ai-continue-btn').onclick = function() {
      window.aiContinue();
    };
    </script>
    </div>
    <div class="d-flex justify-content-between align-items-center mt-4">
      <!-- 新增“保存草稿”按钮，仅保存为草稿，不触发发布/审核流程 -->
      <button type="button" class="btn btn-secondary" id="save-draft-btn">保存草稿</button>
      <!-- 新增“发布”按钮，弹出modal选择模式并审核后发布 -->
      <button type="button" class="btn btn-primary ms-2" id="publish-btn" data-bs-toggle="modal" data-bs-target="#saveModeModal">发布</button>
      <span id="save-status" class="ms-3"></span>
    </div>
  </form>
  <hr>
  <div id="stats-area" class="mt-3">
    <h5>统计信息</h5>
    <div>总字数：<span id="stat-words">0</span>，中文字符：<span id="stat-cn">0</span>，英文单词：<span id="stat-en">0</span>，丰富度：<span id="stat-rich">0</span></div>
    <div>高频词：<span id="stat-top"></span>，敏感词：<span id="stat-sensitive"></span></div>
  </div>
  <hr>
  <div id="sections-area" class="mt-3">
    <h5>章节目录</h5>
    <ul id="section-list"></ul>
  </div>
  <!-- 保存模式选择Modal -->
  <div class="modal fade" id="saveModeModal" tabindex="-1" aria-labelledby="saveModeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="saveModeModalLabel" style="color: #212529;">选择保存模式</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
        </div>
        <div class="modal-body" style="color: #212529;">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="saveMode" id="modePersonal" value="personal" checked>
            <label class="form-check-label" for="modePersonal">个人模式</label>
          </div>
          <div class="form-check mt-2">
            <input class="form-check-input" type="radio" name="saveMode" id="modeCollab" value="collab">
            <label class="form-check-label" for="modeCollab">协作模式</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-success" id="confirmSaveBtn">发布</button>
        </div>
      </div>
    </div>
  </div>
  </form>
</div>
<script src="/static/js/socket.io.min.js?v={{ static_version }}"></script>
<script src="/static/js/work_edit.js"></script>
{% endblock %}
