{% extends 'base.html' %}
{% block title %}工坊创作{% endblock %}
{% block content %}
<div class="container mt-4">
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/">首页</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('workshop.home') }}">工坊</a></li>
      <li class="breadcrumb-item active">创作</li>
    </ol>
  </nav>
  <div class="card">
    <div class="card-header">
      <h4>工坊创作</h4>
    </div>
    <div class="card-body">
      <form id="workshop-form" method="post" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="mb-3">
          <label class="form-label" for="title">标题</label>
          <input type="text" class="form-control" name="title" id="title" placeholder="请输入作品标题" required>
          <div class="invalid-feedback">请填写此字段</div>
        </div>
        <div class="mb-3">
          <label class="form-label" for="description">作品说明</label>
          <textarea class="form-control" name="description" id="description" rows="3" placeholder="支持Markdown"></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">创作方式</label>
          <div>
            <input type="radio" name="mode" id="mode_online" value="online" checked> <label for="mode_online" class="me-2">在线创作</label>
            <input type="radio" name="mode" id="mode_upload" value="upload" class="ms-3"> <label for="mode_upload">上传文件</label>
          </div>
        </div>
        <div class="mb-3" id="online-editor">
          <label class="form-label" for="content">正文内容（支持#分章节）</label>
          <textarea class="form-control" name="content" id="content" rows="10" placeholder="正文内容"></textarea>
          <div class="invalid-feedback">请填写此字段</div>
          <div class="form-text text-info">章节格式：<b># 标题</b>（#后需有空格，否则不识别为章节）</div>
          <div class="mb-3 mt-2">
            <button type="button" class="btn btn-info" id="ai-continue-btn">AI续写</button>
            <label class="ms-2">温度</label>
            <input type="number" id="ai-temperature" value="0.7" min="0" max="1" step="0.1" style="width:80px;">
            <span id="ai-status" class="ms-2 text-muted"></span>
            <div class="form-check form-check-inline ms-3">
              <input class="form-check-input" type="checkbox" id="ai-web-search" value="1">
              <label class="form-check-label" for="ai-web-search">联网搜索增强</label>
            </div>
          </div>
          <div class="mb-3" id="ai-facts-area" style="display:none;">
            <div class="form-label">AI事实增强：</div>
            <ul id="ai-facts-list" class="text-info small mb-0"></ul>
            <div id="ai-facts-raw" class="text-info small"></div>
          </div>
        </div>
        <div class="mb-3 d-none" id="upload-area">
          <label class="form-label" for="file">上传文件</label>
          <input type="file" class="form-control" name="file" id="file">
          <div class="invalid-feedback">请填写此字段</div>
          <div class="form-text">支持 txt, md, pdf, docx 文件</div>
          <!-- Dropzone 拖拽上传区（可选） -->
          <div class="mt-2">
            <div class="form-label">拖拽上传文件（可选）</div>
            {% if dropzone %}
            <div id="dropzone-area">{{ dropzone.create(action=url_for('workshop.upload_file'), input_name='file', multiple=False) }}</div>
            {% endif %}
            <div class="form-text">可拖拽上传，支持与上方选择框共用。</div>
          </div>
        </div>
        <div class="d-flex justify-content-between align-items-center mt-4">
          <button type="button" class="btn btn-primary" id="save-btn">保存草稿</button>
          <div class="ml-auto d-flex align-items-center">
            <button type="button" class="btn btn-success me-2" id="publish-btn" disabled>发布</button>
            <span id="publish-hint" class="small" style="color: #212529;">发布前请先填写标题和正文并保存草稿</span>
          </div>
        </div>
      <!-- 发布设置Modal -->
      <div class="modal fade" id="publishModal" tabindex="-1" aria-labelledby="publishModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header" style="color: #212529;">
              <h5 class="modal-title" id="publishModalLabel" style="color: #212529;">发布作品设置</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body" style="color: #212529;">
              <form id="publish-form">
                <div class="mb-3">
                  <label class="form-label">发布类型</label><br>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="pub_type" id="pub_type_personal" value="personal" checked>
                    <label class="form-check-label" for="pub_type_personal">个人</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="pub_type" id="pub_type_collab" value="collab">
                    <label class="form-check-label" for="pub_type_collab">协作</label>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">作品主题</label>
                  <select class="form-select" id="pub-theme" name="pub_theme">
                    <option value="社会">社会</option>
                    <option value="情感">情感</option>
                    <option value="奇幻">奇幻</option>
                    <option value="科幻">科幻</option>
                    <option value="抽象">抽象</option>
                    <option value="custom">自定义</option>
                  </select>
                  <input type="text" class="form-control mt-2 d-none" id="custom-theme-input" name="custom_theme" placeholder="请输入自定义主题名">
                </div>
                <div class="mb-3 form-check">
                  <input type="checkbox" class="form-check-input" id="agree-protocol" name="agree_protocol">
                  <label class="form-check-label" for="agree-protocol">我已阅读并同意 <a href="/docs/publish_protocol" target="_blank">平台作品发布协议</a></label>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="button" class="btn btn-success" id="modal-publish-btn" disabled>发布</button>
            </div>
          </div>
        </div>
      </div>
      </form>
      <hr>
      <div id="stats-area" class="mt-3">
        <h5>统计信息</h5>
        <div>总字数：<span id="stat-words">0</span>，中文字符：<span id="stat-cn">0</span>，英文单词：<span id="stat-en">0</span>，丰富度：<span id="stat-rich">0</span></div>
        <div>高频词：<span id="stat-top"></span>，敏感词：<span id="stat-sensitive"></span></div>
      </div>
      <hr>
      <div id="sections-area" class="mt-3">
        <h5>章节目录</h5>
        <ul id="section-list"></ul>
      </div>
    </div>
  </div>
</div>
<script src="/static/js/socket.io.min.js?v={{ static_version }}"></script>
<script src="/static/js/workshop_editor.js?v={{ static_version }}"></script>
{% endblock %}
